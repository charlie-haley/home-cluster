---
- hosts:
  - master
  - workers
  become: true
  gather_facts: true
  vars:
    k3s_version: "v1.21.3+k3s1"
  tasks:
  - name: cluster-init | set hostname
    become: true
    shell: hostnamectl set-hostname {{ hostname }}
    when: type == "sbc"

  - name: cluster-init | enable cgroup
    become: true
    shell: sed ' 1 s/.*/& cgroup_enable=memory cgroup_memory=1/' /boot/firmware/cmdline.txt -i
    when: type == "sbc"

  - name: cluster-init | install nfs-common
    become: true
    shell: |
      sudo apt update
      sudo apt install -y nfs-common

  - name: cluster-init | k3sup master node
    become: true
    shell: |
      k3sup install \
      --host={{ groups['master'][0] }} \
      --user=ubuntu \
      --k3s-version={{ k3s_version }} \
      --k3s-extra-args="--disable servicelb --disable traefik" \
      --local-path $HOME/.kube/config
    delegate_to: 127.0.0.1
    ignore_errors: yes
    when: "'master' in group_names"

  - name: cluster-init | k3sup join worker nodes
    become: true
    shell: |
      k3sup join \
          --host={{ item }} \
          --server-host={{ groups['master'][0] }} \
          --k3s-version={{ k3s_version }} \
          --user=ubuntu
    with_items:
    - "{{ groups['workers'] }}"
    delegate_to: 127.0.0.1
    ignore_errors: yes
    when: "'workers' in group_names"

  - name: cluster-init | reboot node
    reboot:
    when: type == "sbc"
