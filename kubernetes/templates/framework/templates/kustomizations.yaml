{{- range $namespace, $v := .Values.namespaces }}
apiVersion: v1
kind: Namespace
metadata:
  name: {{ $namespace }}
# Bit of a hack until I sort out privileged in the templates
{{- if or (eq $namespace "observability") (eq $namespace "storage") }}
  labels:
    # These have to be set currently due to node exporter.
    pod-security.kubernetes.io/warn: privileged
    pod-security.kubernetes.io/enforce: privileged
{{- end }}
---
{{- range $name, $config := $v -}}
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: {{ $namespace }}-{{ $name }}
  namespace: {{ $.Values.namespace }}
spec:
  interval: 10m
  targetNamespace: {{ $namespace }}
  prune: true
  sourceRef:
    kind: {{ $.Values.sourceRef.kind }}
    name: {{ $.Values.sourceRef.name }}
    namespace: {{ $.Values.namespace }}
  path: ./{{ $namespace }}/{{ $name }}
{{- with $config.dependsOn }}
  dependsOn:
  {{- toYaml . | nindent 4 }}
{{- end }}
  postBuild:
    substituteFrom:
      - kind: Secret
        name: vilya-flux
      - kind: ConfigMap
        name: vilya-flux
  decryption:
    provider: sops
    secretRef:
      name: sops-age
---
{{- end }}

{{- end -}}
