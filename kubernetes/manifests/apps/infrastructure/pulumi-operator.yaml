---
helm:
  repo: https://raw.githubusercontent.com/pulumi/pulumi-kubernetes-operator/gh-pages/
  chart: pulumi-kubernetes-operator
  version: 0.5.0

values:
  image:
    repository: pulumi/pulumi-kubernetes-operator
    tag: 1.14.0
  serviceAccount:
    create: false
    name: "pulumi-operator-pulumi-kubernetes-operator"
  extraVolumes:
    - name: ssh-auth
      secret:
        secretName: pulumi-ssh-credentials
  extraVolumeMounts:
    - name: ssh-auth
      readOnly: true
      mountPath: "/etc/ssh/pulumi"

resources:
  - apiVersion: source.toolkit.fluxcd.io/v1
    kind: GitRepository
    metadata:
      name: home-infra
    spec:
      interval: 60m
      ref:
        branch: main
      url: ssh://github.com/charlie-haley/home-infra
      secretRef:
        name: ssh-credentials

  - apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: pulumi-operator-pulumi-kubernetes-operator

  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: pulumi-operator
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: pulumi-operator
    subjects:
      - kind: ServiceAccount
        name: pulumi-operator-pulumi-kubernetes-operator

  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: pulumi-operator
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: pulumi-operator
    subjects:
      - kind: ServiceAccount
        name: pulumi-operator-pulumi-kubernetes-operator

  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: pulumi-operator
    rules:
      - apiGroups:
          - source.toolkit.fluxcd.io
        resources:
          - gitrepositories
        verbs:
          - get
          - list
          - watch

  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: pulumi-operator
    rules:
      - apiGroups:
          - ""
        resources:
          - pods
          - services
          - services/finalizers
          - endpoints
          - persistentvolumeclaims
          - events
          - configmaps
          - secrets
        verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
      - apiGroups:
          - apps
        resources:
          - deployments
          - daemonsets
          - replicasets
          - statefulsets
        verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
      - apiGroups:
          - monitoring.coreos.com
        resources:
          - servicemonitors
        verbs:
          - get
          - create
      - apiGroups:
          - apps
        resourceNames:
          - pulumi-kubernetes-operator
        resources:
          - deployments/finalizers
        verbs:
          - update
      - apiGroups:
          - ""
        resources:
          - pods
        verbs:
          - get
      - apiGroups:
          - apps
        resources:
          - replicasets
          - deployments
        verbs:
          - get
      - apiGroups:
          - pulumi.com
        resources:
          - "*"
        verbs:
          - create
          - delete
          - get
          - list
          - patch
          - update
          - watch
      - apiGroups:
          - coordination.k8s.io
        resources:
          - leases
        verbs:
          - create
          - get
          - list
          - update
