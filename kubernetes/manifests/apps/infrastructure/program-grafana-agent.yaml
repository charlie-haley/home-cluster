---
dependsOn:
  - name: infrastructure-pulumi-operator

resources:
  - apiVersion: pulumi.com/v1
    kind: Program
    metadata:
      name: grafana-agent
    program:
      resources:
        docker-provider:
          type: pulumi:providers:docker
          properties:
            host: $${host}
            sshOpts:
              - "-o"
              - "StrictHostKeyChecking=no"
              - "-i"
              - "/etc/ssh/pulumi/identity"
        agent-image:
          type: docker:RemoteImage
          properties:
            name: "docker.io/grafana/agent:v0.38.1"
          options:
            provider: $${docker-provider}
        agent-container:
          type: docker:Container
          properties:
            image: $${agent-image.imageId}
            restart: always
            privileged: true
            pidMode: host
            networkMode: host
            usernsMode: host
            groupAdds:
              - adm
            envs:
              - "AGENT_MODE=flow"
              # This can also be removed once the content is no longer b64 encoded. See below for further comments.
              - "LOG_ENDPOINT=$${logsEndpoint}"
              - "METRICS_ENDPOINT=$${metricsEndpoint}"
              - "INSTANCE=$${instance}"
            capabilities:
              adds:
                - SYS_TIME
            mounts:
              - type: bind
                target: /host/proc
                source: /proc
                bindOptions:
                  propagation: rslave
              - type: bind
                target: /host/sys
                source: /sys
                bindOptions:
                  propagation: rslave
                readOnly: true
              - type: bind
                target: /host/root
                source: /
                bindOptions:
                  propagation: rslave
                readOnly: true
            command:
              - run
              - --server.http.listen-addr=0.0.0.0:12345
              - /config.river
            uploads:
              - file: /config.river
                # This has to be base64 encoded for now due to a bug with YQ and multiline strings...
                # https://github.com/mikefarah/yq/issues/566
                # This can be removed once the templating logic is moved to a programming language
                contentBase64: bG9jYWwuZmlsZV9tYXRjaCAidmFyX2xvZyIgewoJcGF0aF90YXJnZXRzID0gWwogICAgewoJCSAgX19hZGRyZXNzX18gPSAibG9jYWxob3N0IiwKCQkgIF9fcGF0aF9fICAgID0gIi9ob3N0L3Jvb3QvdmFyL2xvZy8qLmxvZyIsCgkgIH0sCiAgICB7CiAgICAgIF9fYWRkcmVzc19fID0gImxvY2FsaG9zdCIsCiAgICAgIF9fcGF0aF9fICAgID0gIi9ob3N0L3Jvb3QvdmFyL2xvZy9tZXNzYWdlcyIsCiAgICB9LAogIF0KfQoKbG9raS5zb3VyY2UuZmlsZSAidmFyX2xvZyIgewoJdGFyZ2V0cyAgICA9IGxvY2FsLmZpbGVfbWF0Y2gudmFyX2xvZy50YXJnZXRzCglmb3J3YXJkX3RvID0gW2xva2kud3JpdGUubG9raS5yZWNlaXZlcl0KfQoKbG9raS5zb3VyY2Uuam91cm5hbCAiam91cm5hbCIgewogIGZvcndhcmRfdG8gICAgPSBbbG9raS53cml0ZS5sb2tpLnJlY2VpdmVyXQogIHBhdGggPSAiL2hvc3Qvcm9vdC92YXIvbG9nL2pvdXJuYWwiCn0KCmxva2kud3JpdGUgImxva2kiIHsKICBlbmRwb2ludCB7CiAgICB1cmwgPSBlbnYoIkxPR19FTkRQT0lOVCIpCiAgfQogIGV4dGVybmFsX2xhYmVscyA9IHsKICAgIGluc3RhbmNlID0gZW52KCJJTlNUQU5DRSIpLAogIH0KfQoKLy8gTm9kZSBleHBvcnRlcgpwcm9tZXRoZXVzLmV4cG9ydGVyLnVuaXggIm5vZGUiIHsKICBwcm9jZnNfcGF0aCA9ICIvaG9zdC9wcm9jIgogIHN5c2ZzX3BhdGggPSAiL2hvc3Qvc3lzIgogIHJvb3Rmc19wYXRoID0gIi9ob3N0L3Jvb3QiCiAgdWRldl9kYXRhX3BhdGggPSAiL2hvc3Qvcm9vdC9ydW4vdWRldi9kYXRhIgp9CgpkaXNjb3ZlcnkucmVsYWJlbCAibm9kZSIgewogIHRhcmdldHMgICAgPSBwcm9tZXRoZXVzLmV4cG9ydGVyLnVuaXgubm9kZS50YXJnZXRzCgogIHJ1bGUgewogICAgYWN0aW9uID0gImxhYmVsZHJvcCIKICAgIHJlZ2V4ICA9ICJqb2IiCiAgfQp9Cgpwcm9tZXRoZXVzLnNjcmFwZSAibm9kZSIgewogIHRhcmdldHMgICAgPSBkaXNjb3ZlcnkucmVsYWJlbC5ub2RlLm91dHB1dAogIGZvcndhcmRfdG8gPSBbcHJvbWV0aGV1cy5yZW1vdGVfd3JpdGUubWltaXIucmVjZWl2ZXJdCiAgam9iX25hbWUgPSAibm9kZS1leHBvcnRlciIKfQoKcHJvbWV0aGV1cy5yZW1vdGVfd3JpdGUgIm1pbWlyIiB7CiAgZW5kcG9pbnQgewogICAgdXJsID0gZW52KCJNRVRSSUNTX0VORFBPSU5UIikKICB9CiAgZXh0ZXJuYWxfbGFiZWxzID0gewogICAgaW5zdGFuY2UgPSBlbnYoIklOU1RBTkNFIiksCiAgfQp9CgpkaXNjb3ZlcnkuZG9ja2VyICJjb250YWluZXJzIiB7CiAgaG9zdCA9ICJ1bml4Oi8vL3Zhci9ydW4vZG9ja2VyLnNvY2siCiAgZmlsdGVyIHsKICAgIG5hbWUgPSAibGFiZWwiCiAgICB2YWx1ZXMgPSBbInByb21ldGhldXMuaW8vc2NyYXBlPXRydWUiXQogIH0KfQoKcHJvbWV0aGV1cy5zY3JhcGUgImNvbnRhaW5lcnMiIHsKICB0YXJnZXRzICAgID0gZGlzY292ZXJ5LmRvY2tlci5jb250YWluZXJzLnRhcmdldHMKICBmb3J3YXJkX3RvID0gW3Byb21ldGhldXMucmVtb3RlX3dyaXRlLm1pbWlyLnJlY2VpdmVyXQogIGpvYl9uYW1lID0gImRvY2tlci1kaXNjb3ZlcnkiCn0K
          options:
            provider: $${docker-provider}
