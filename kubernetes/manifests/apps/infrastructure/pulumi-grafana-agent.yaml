---
dependsOn:
  - name: infrastructure-pulumi-operator

resources:
  - apiVersion: v1
    kind: Secret
    metadata:
      name: pulumi-secrets
    stringData:
      PULUMI_ACCESS_TOKEN: ${PULUMI_ACCESS_TOKEN}

  - apiVersion: pulumi.com/v1
    kind: Stack
    metadata:
      name: narya-grafana-agent
    spec:
      stack: home-infra/grafana-agent/dev
      fluxSource:
        sourceRef:
          apiVersion: source.toolkit.fluxcd.io/v1
          kind: GitRepository
          name: home-infra
        dir: pulumi/grafana-agent/
      destroyOnFinalize: true
      envRefs:
        PULUMI_ACCESS_TOKEN:
          type: Secret
          secret:
            name: pulumi-secrets
            key: PULUMI_ACCESS_TOKEN
      config:
        grafana-agent:host: "ssh://pulumi@narya:22"
        grafana-agent:instance: "narya"
        grafana-agent:metricsEndpoint: "https://mimir.${SECRET_DOMAIN}/api/v1/push"
        grafana-agent:logsEndpoint: "https://loki.${SECRET_DOMAIN}/api/v1/push"
