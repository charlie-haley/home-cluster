---
helm:
  repo: https://bjw-s.github.io/helm-charts
  chart: app-template
  version: 2.4.0

values:
  controllers:
    main:
      type: deployment
      containers:
        main:
          image:
            repository: balabit/syslog-ng
            tag: 4.5.0
          args:
            - --no-caps
            - -f
            - /config/config.yml
          probes:
            liveness:
              type: UDP
            readiness:
              type: UDP
            startup:
              type: UDP
  service:
    main:
      type: LoadBalancer
      annotations:
        "io.cilium/lb-ipam-ips": "192.168.2.15"
      ports:
        http:
          port: 514
  persistence:
    config:
      enabled: true
      type: configMap
      name: syslog-ng-config
  configMaps:
    config:
      enabled: true
      data:
        config.yml: |
          @version: 4.5
          @include "scl.conf"

          source s_local {
            internal();
          };

          source s_network {
            syslog(
              udp-port(514)
              transport("tls")
              flags(no-parse)
            );
          };

          filter f_syslconn {
            not match("Syslog connection accepted;" type("string"));
            not match("Syslog connection closed;" type("string"));
          };

          destination d_loki {
            syslog("grafana-agent-node.observability.svc.cluster.local" transport("udp") port("51414"));
          };

          log {
            source(s_network);
            filter(f_syslconn);
            destination(d_loki);
          };
